
<!-- 쿠폰/포인트 사용 -->
<div class="ui_accordion cart_list">
	<dl>
		<dt class="on">
			<strong class="tit">쿠폰/포인트 사용</strong>
			<button type="button"><span class="sr_only">열기</span></button>
		</dt>
		<dd>
			<ul class="use_list">
				<li>
					<div class="inquiry">
						<strong class="tit">쿠폰할인</strong>
						<div class="sell">
							<span class="price">-30000원</span>
							<a href="#none" class="btn_fix_gradient">쿠폰조회</a>
						</div>
					</div>
					<ul class="coupon_list">	 <!-- 쿠폰조회 하면 나오는 영역 -->
						<li>
							<p>[첫구매] 회원등급 발급쿠폰 (2018년 12월 31일까지)</p><span class="price">- 15,000원</span>
							<span class="blank"></span>
						</li>
						<li>
							<p>[수퍼쿠폰] 회원등급 발급쿠폰 (2018년 12월 31일까지 )</p><span class="price">- 15,000원</span>
							<span class="blank"></span>
						</li>
					</ul>
					<div class="ui_accordion guide_list">
						<dl>
							<dt class="txt">
								<p>더 자세한 쿠폰할인 안내</p> <!-- 문구수정_2018-08-23 -->
								<button type="button"><span class="sr_only">열기</span></button>
							</dt>
							<dd class="expl">
								<strong class="tit">쿠폰안내</strong>
								<ul>
									<li>보유한 쿠폰의 사용조건은 상이하며, 자세한 내용은 [마이파우치 - 쿠폰 - 쿠폰안내]에서 확인하실 수 있습니다. </li>
									<li>일부 브랜드 또는 상품은 쿠폰 적용 대상에서 제외될 수 있습니다.</li>
									<li>할인 쿠폰 사용시 할인액을 제외한 결제금액을 기준으로 뷰티포인트가 적립됩니다.</li>
									<li>부분취소/환불시 주문 단위로 적용된 쿠폰은 복원되지 않습니다.</li>
									<li>사용한 쿠폰의 유효기간이 만료된 후에는 해당 쿠폰이 복원되지 않습니다.</li>
								</ul>
							</dd>
						</dl>
					</div>
				</li>
				<li>
					<div class="inquiry">
						<strong class="tit">기프트카드</strong>
						<div class="sell">
							<span class="price">0원</span>
							<a href="#none" class="btn_fix_gradient">카드조회</a>
						</div>
					</div>
					<ul class="coupon_list"> <!-- 카드조회 하면 나오는 영역 -->
						<li>
							<p>기프트카드 10,000원</p><span class="price">- 5,000원</span>
							<span class="blank"></span>
						</li>
					</ul>
					<div class="ui_accordion guide_list">
						<dl>
							<dt class="txt">
								<p>기프트카드를 바로 등록하고 사용할 수 있습니다.</p>
								<button type="button"><span class="sr_only">열기</span></button>
							</dt>
							<dd class="expl">
								<strong class="tit">기프트카드 사용안내</strong>
								<ul>
									<li>보유하고 계신 기프트카드의 일부 또는 전액을 결제금액에서 차감하여 사용이 가능합니다.</li>
									<li>기프트카드의 남은 잔액은 유효기간 내에 사용 가능합니다.</li>
									<li>기프트카드는 타인에게 양도가 불가합니다. </li>
									<li>기프트카드 사용 주문건의 취소/반품/환불시 사용된 금액은 처리 완료시점에 자동 복구됩니다.</li>
									<li>기프트카드 사용 및 환불 문의는 고객센터를 이용해주시기 바랍니다.</li>
								</ul>
							</dd>
						</dl>
					</div>
				</li>
				<li>
					<div class="inquiry">
						<strong class="tit">예치금</strong>
						<div class="sell">
												<span class="price">
													<span class="own">보유한 예치금 : 70,000원</span>
													<span class="input_wrap"><input type="text" name="" id="" placeholder="0"></span> 원
												</span>
							<a href="#none" class="btn_fix_gradient">모두사용</a>
						</div>
					</div>
					<div class="ui_accordion guide_list">
						<dl>
							<dt class="txt">
								<p>더 자세한 예치금 안내</p>
								<button type="button"><span class="sr_only">열기</span></button>
							</dt>
							<dd class="expl">
								<strong class="tit">예치금 사용안내</strong>
								<ul>
									<li>보유하고 계신 예치금의 일부 또는 전액을 결제금액에서 차감하여 사용이 가능합니다. </li>
									<li>예치금 사용 주문건의 취소/반품/환불시 사용된 금액은 처리 완료시점에 자동 복구됩니다.</li>
								</ul>
							</dd>
						</dl>
					</div>
				</li>
				<li>
					<div class="inquiry">
						<strong class="tit">뷰티포인트</strong>
						<div class="sell">
												<span class="price">
													<span class="own">보유한 뷰티포인트 : 50,000원</span>
													<span class="input_wrap"><input type="text" name="" id="" placeholder="0"></span> 원
												</span>
							<a href="#none" class="btn_fix_gradient">모두사용</a>
						</div>
					</div>
					<div class="ui_accordion guide_list">
						<dl>
							<dt class="txt">
								<p>포인트 사용시 스페셜기프트가 증정되지 않습니다.</p>
								<button type="button"><span class="sr_only">열기</span></button>
							</dt>
							<dd class="expl">
								<strong class="tit">뷰티포인트 사용안내</strong>
								<ul>
									<li>보유하고 계신 뷰티포인트를 10P 단위로 결제금액에서 차감하여 사용이 가능합니다. (일부 상품 제외)</li>
									<li>배송비는 뷰티포인트로 결제하실 수 없습니다.</li>
									<li>뷰티포인트 사용시 스페셜 기프트는 증정되지 않습니다. </li>
									<li>뷰티포인트 사용금액을 제외한 최종 결제금액 기준으로 구매금액대 사은품이 증정됩니다</li>
									<li>2개 이상의 상품 구매시, 최종 결제금액 비중으로 포인트 사용분이 자동으로 배분되어 결제됩니다.</li>
									<li>뷰티포인트 전용 상품 구매시, 전용 상품에 포인트가 먼저 전액 적용되고 남은 상품에 포인트가 배분됩니다.</li>
									<li>뷰티포인트 사용 주문건의 취소/반품/환불시 사용된 포인트는 처리 완료시점에 자동 복구됩니다. </li>
								</ul>
							</dd>
						</dl>
					</div>
				</li>
				<li>
					<div class="inquiry">
						<strong class="tit">P포인트</strong>
						<div class="sell">
												<span class="price">
													<span class="own">보유한 P 포인트 : 50,000원</span>
													<span class="input_wrap"><input type="text" name="" id="" placeholder="0"></span> 원
												</span>
							<a href="#none" class="btn_fix_gradient">모두사용</a>
						</div>
					</div>
					<div class="ui_accordion guide_list">
						<dl>
							<dt class="txt">
								<p>더 자세한 P 포인트 안내</p>
								<button type="button"><span class="sr_only">열기</span></button>
							</dt>
							<dd class="expl">
								<strong class="tit">P포인트 사용안내</strong>
								<ul>
									<li>보유하고 계신 P포인트를 결제금액에서 차감하여 사용이 가능합니다.</li>
									<li>P포인트는 ‘임직원 할인(30%)’이 적용된 상품에만 적용할 수 있습니다. </li>
									<li>P포인트 적용시 상품 정상가격의 50%까지 포인트 차감할인이 가능합니다.</li>
									<li>P포인트 사용 주문건의 취소/반품/환불시 사용된 포인트는 처리 완료시점에 자동 복구됩니다.</li>
									<li>P포인트는 당해 1월 1일부터 12월 31일까지 사용 가능하며, 다음 해 이월은 불가능합니다.</li>
								</ul>
							</dd>
						</dl>
					</div>
				</li>
			</ul>
		</dd>
	</dl>
</div>
<!-- // 쿠폰/포인트 사용 -->

	<script th:inline="javascript">
		var ordSn = /*[[${ordEx.ordSn}]]*/ 0;
		var modal;

		//쿠폰조회
		$('#b_coupon').off('click').on('click', function() {
			getCouponLayer();
		});

		//뷰티포인트
		$('[name=beauty_point]').on('change', function() {
			var membershipSn = this.dataset.membershipsn,
				useMembershipPoint = parseInt(this.value);

			if (this.value == '' || useMembershipPoint == null)  useMembershipPoint = 0;

			if (useMembershipPoint >= 0 && useMembershipPoint <= parseInt(this.max)) {
				calculationPoint(membershipSn, useMembershipPoint);
			} else {
				var max = this.max;
				AP.modal.info({
					contents: '사용가능한 뷰티포인트는 ' + max + 'P입니다.',
					confirmLabel: '확인',
					cancelLabel: '취소'
				}).addListener('modal-close', function (e) {
					if (e.closeType === 'confirm') {
						$('[name=beauty_point]').val(max);
						calculationPoint(membershipSn, max);
					} else {
						$('[name=beauty_point]').val('');
					}
				});
			}

		});

		function calculationPoint(membershipSn, useMembershipPoint){
			$('#orderLoading').show();

			AP.api.ordReceptChangePoint({}, {
				ordSn : ordSn,
				membershipSn : membershipSn,
				useMembershipPoint : useMembershipPoint
			}).done(function (data) {
				if (data.ordHistEx != null) {
					amtPcurInitAjax(data);

					if ($('[name="depositPrice"]') != undefined && $('[name="depositPrice"]').val() != ""){
						AP.modal.alert('뷰티포인트 사용으로 예치금 사용이 초기화됩니다. <br/>예치금 사용액을 다시 입력해 주세요.');
						$('[name="depositPrice"]').val('')
					}
				}
			}).always(function(){
				$('#orderLoading').hide();
			});
		}

		//쿠션포인트
		$('#cushion_point').on('change', function() {
			if ($(this).prop('checked')) {
				console.log("cushion checked")
			}
		});

		//OKCashbag조회
		$('[name=okcashbag]').off('click').on('click', function() {
			AP.modal.alert("OK Cashbag 서비스 준비중입니다...")
		});

		//보유한 쿠폰 Layer
		function getCouponLayer(){
			if (isApMember) {
				//layer 및 보유 쿠폰 조회
				getAvailCouponList('first');
			} else {
				initLayer();
				registerCouponEvent();
			}
		}

		function initLayer() {
			modal = AP.modal.info({
				contents: {
					templateKey: 'order.fullpage-coupon-use',
					templateModel: {
						isApMember : isApMember
					}
				},
				sizeType: 'L',
				containerClass: 'coupon_layer'
			});

			// 탭상위(tab)
			modal.getElement().find( '.ui_tab' ).tabs();
			$( '.ui_tab' ).on('tabs-change', function(e){
                //console.log(e.index)
                if (e.index == 0) {
					getAvailCouponList('reClick');
				}
                if (e.index == 1) {
					getDownloadCouponList();
				}
            });

			// 쿠폰목록(accordion)
			modal.getElement().find( '.ui_accordion' ).accordion();
		}

		//쿠폰등록
		function registerCouponEvent() {
			$('#registerBtn').off('click').on('click', function() {
				var coupon = $('[name=couponIdentifier]').val();
				if (coupon) {
					if (isApMember) {
						//회원
						AP.api.registerCoupon({}, {
							couponIdentifier: coupon
						}).done(function (data) {
							//성공
							AP.modal.alert("온라인 전용 쿠폰 등록했습니다.");
							getAvailCouponList('reClick');
						}).fail(function(xhr) {
							//실패
							if (xhr.errorCode == 0) {
								AP.modal.alert("인터넷이 연결되지 않습니다. 연결 상태를 확인해주세요.");
							} else if (xhr.errorCode == 'ESAL089') {
								AP.modal.alert("발급가능횟수를 초과하였습니다.");
							} else if (xhr.errorCode == 'ESAL090') {
								AP.modal.alert("회원별 발급제한 횟수를  초과하였습니다.");
							} else if (xhr.errorCode == 'ESAL091') {
								AP.modal.alert("해당 쿠폰코드로 조회된 쿠폰정보가 없습니다.");
							} else if (xhr.errorCode == 'ESAL092') {
								AP.modal.alert("이미 발급된 쿠폰입니다.");
							} else if (xhr.errorCode == 'ESAL093') {
								AP.modal.alert("쿠폰 발급 기간이 아닙니다.");
							} else {
								AP.modal.alert("쿠폰등록 실패했습니다, 쿠폰번호 확인하세요.");
							}
						}).always(function() {
							//성공, 실패
						});
					} else {
						//비회원
						AP.api.registerNoMemberCoupon({}, {
							couponIdentifier: coupon
						}).done(function (data) {
							//성공
							AP.modal.alert("온라인 전용 쿠폰 등록했습니다.");
							getAvailCouponList('reClick');
						}).fail(function(xhr) {
							//실패
							if (xhr.errorCode == 0) {
								AP.modal.alert("인터넷이 연결되지 않습니다. 연결 상태를 확인해주세요.");
							} else if (xhr.errorCode == 'ESAL089') {
								AP.modal.alert("발급가능횟수를 초과하였습니다.");
							} else if (xhr.errorCode == 'ESAL090') {
								AP.modal.alert("회원별 발급제한 횟수를  초과하였습니다.");
							} else if (xhr.errorCode == 'ESAL091') {
								AP.modal.alert("해당 쿠폰코드로 조회된 쿠폰정보가 없습니다.");
							} else if (xhr.errorCode == 'ESAL092') {
								AP.modal.alert("이미 발급된 쿠폰입니다.");
							} else if (xhr.errorCode == 'ESAL093') {
								AP.modal.alert("쿠폰 발급 기간이 아닙니다.");
							} else {
								AP.modal.alert("쿠폰등록 실패했습니다, 쿠폰번호 확인하세요.");
							}
						}).always(function() {
							//성공, 실패
						});
					}
				} else {
					AP.modal.alert("쿠폰번호를 입력하세요.")
				}
			});
		}

		//보유쿠폰 목록
		var g_xhr;
		function getAvailCouponList(flag) {

			if (g_xhr != null) {
				g_xhr.abort();
			}

			g_xhr = AP.api.getCouponList({}, {
				ordSn : ordSn
			}).done(function(data) {
				if (data.result = "success") {

					if ('first' == flag) {
						initLayer();
					}

					var coupon = {
						couponCnt : data.availCouponCnt,
						list : data.availCouponExList
					};

					var html = AP.common.getTemplate( 'order.fullpage-coupon-use-avail', {
						coupon: coupon
					});

					$('.availCoupon').html(html);
					$( '.ui_accordion' ).accordion();
					$('.downloadCouponEmpty').html('');

					// 쿠폰 선택
					$('[name=couponSn]').off('click').on('click', function(e) {
						if(!$(this).prop('checked')) {
							$('[id="'+this.id+'"]').prop('checked', false);
						}else{
							var couponId = this.id;
							//쿠폰 체크 로직
							//console.log(this.dataset.code);
							//1. 단독쿠폰: 다른 단독 및 중복 전부 헤제
							if ("Exclusive" == this.dataset.code) {

								if ($('[data-code="Exclusive"]:checked').not($(this)).length > 0 || $('[data-code="Duplication"]:checked').not($(this)).length > 0) {
									//다른 단독쿠폰 선택된거나 중복 쿠폰 선택 된 경우

									AP.modal.info({
										contents: '선택하신 쿠폰은 다른 쿠폰과 중복사용할 수 없습니다. <br/>적용하시겠습니까?',
										confirmLabel: '확인',
										cancelLabel: '취소'
									}).addListener('modal-close', function (e) {
										if (e.closeType === 'confirm') {
											$('[data-code="Exclusive"]').prop('checked', false);
											$('[data-code="Duplication"]').prop('checked', false);
											$('[id="' + couponId + '"]').prop('checked', true);
										} else {
											$('[id="' + couponId + '"]').prop('checked', false);
										}
									});
								} else {
									$('[id="' + couponId + '"]').prop('checked', true);
								}
							}
							//2. 중복쿠폰: 단독 전부 헤제
							if ("Duplication" == this.dataset.code) {

								if ($('[data-code="Exclusive"]:checked').length > 0) {
									//단독쿠폰 선택 된 경우

									AP.modal.info({
										contents: '이미 선택하신 단독쿠폰을 취소해야 적용가능합니다. <br/>단독쿠폰사용을 취소하시겠습니까?',
										confirmLabel: '확인',
										cancelLabel: '취소'
									}).addListener('modal-close', function (e) {
										if (e.closeType === 'confirm') {
											$('[data-code="Exclusive"]').prop('checked', false);
											$('[id="' + couponId + '"]').prop('checked', true);
										} else {
											$('[id="' + couponId + '"]').prop('checked', false);
										}
									});
								} else {
									$('[id="' + couponId + '"]').prop('checked', true);
								}
							}
						}
					});

					//쿠폰등록
					registerCouponEvent();

					// 쿠폰 적용
					$('#b_save').off('click').on('click', function(e) {
						if($("input[name=couponSn]").is(':checked') == false){
							AP.modal.alert("선택하신 쿠폰이 없습니다.");
						}else{
							var applyCouponSnArr = [];
							$("input[name=couponSn]:checked").each(function() {
								applyCouponSnArr.push(this.id);
							});

							drawCouponList(applyCouponSnArr, 'apply');
						}
					});

					// 취소
					$('#b_close').off('click').on('click', function(e) {
						modal.close();
					});
				}
			}).fail(function(xhr) {
				//실패
				AP.modal.alert(xhr.errorMessage);
			}).always(function() {
			});
		}

		//주문서 화면 선택된 쿠폰 영역 그리기
		var a_xhr;
		function drawCouponList(couponSnArr, flag){

			if (a_xhr != null) {
				a_xhr.abort();
			}

			if (flag == 'apply') {
				$('#couponApplyLoading').show();
			} else {
				$('#orderLoading').show();
			}

			if (couponSnArr != null && couponSnArr.length > 0) {
				jQuery.ajaxSettings.traditional = true;
			}
			console.log("적용할 목록: "+couponSnArr);
			a_xhr = AP.api.ordReceptChangeCoupon({}, {
				ordSn : ordSn,
				memberKeepingCouponSnArr: couponSnArr,
				membershipSn : $('[name=beauty_point]').length > 0 ? $('[name=beauty_point]').data().membershipsn : null
			}).done(function (data) {

				if (data != null) {
					if (flag == 'apply') {
						//쿠폰적용(Layer)
						if (data.applyCouponExList != "" && data.applyCouponExList.length > 0) {

							//적용할 쿠폰 존재한 경우
							if (couponSnArr.length == data.applyCouponExList.length) {

								drawCouponUnit(data);
								modal.close();

							} else {
								//사용불가한 쿠폰 존재한 경우
								AP.modal.alert('본주문에 사용하지 못 한 쿠폰 존재합니다.');

								var applyCouponSnArr = [];
								$.each(data.applyCouponExList, function (index, item) {
									if (item.memberKeepingCouponSn > 0) {
										applyCouponSnArr.push(item.memberKeepingCouponSn);
									}
								});

								var resultArr = couponSnArr.filter(function (item) {
									return applyCouponSnArr.indexOf(parseInt(item)) === -1;
								});
								$.each(resultArr, function (index, item) {
									$('[id=' + item + ']').prop('checked', false);
								});

								return;
							}
						} else {
							//적용한 쿠폰 없을때
							$('[name=couponSn]').attr("checked", false);
							AP.modal.alert("이번 주문에 사용할 수 없는 쿠폰을 선택하셨습니다. 쿠폰을 다시 선택해 주세요. ");
						}
					} else {
						//flag == 'remove'
						//쿠폰삭제
						drawCouponUnit(data);
					}
				} else {
					AP.modal.alert("no data error");
				}

			}).fail(function (xhr) {
				//실패
				AP.modal.alert(xhr.errorMessage);
			}).always(function () {
				$('#couponApplyLoading').hide();
				$('#orderLoading').hide();
				jQuery.ajaxSettings.traditional = true;
			});
		}

		//다운로드쿠폰 목록
		function getDownloadCouponList() {
			AP.api.getDownloadCouponList({}, {
			}).done(function(data) {
				if (data.result = "success") {

					var downloadCoupon = {
						couponCnt : data.downloadCouponCnt,
						list : data.downloadCouponList
					};

					var html = AP.common.getTemplate( 'order.fullpage-coupon-use-download', {
						downloadCoupon: downloadCoupon
					});

					$('.downloadCouponArea').html(html);

					// 쿠폰 다운로드
					$('[name=downloadCoupon]').off('click').on('click', function(e) {
						//console.log(this.id);
						AP.api.orderDownloadCoupon( null, {
							couponSn: this.id
						}).done( function ( result ) {
							if (result != null && result.downloadResult == true) {
								AP.modal.alert("다운로드 완료. 보유쿠폰 목록에서 확인하세요.");
								$(this).prop('disabled', true);
							} else {
								AP.modal.alert("다운로드 실패했습니다.");
							}
						}.bind(this)
						).fail( function (xhr) {
							//실패
							console.log(xhr.errorMessage);
						}.bind(this));

					});
				}
			}).fail(function(xhr) {
				//실패
				AP.modal.alert(xhr.errorMessage);
			}).always(function() {
			});
		}

		//적용된 쿠폰목록 그리기
		function drawCouponUnit(data) {

			if (data != null) {
				var couponDcAmtSum = 0
					, couponStr = '';

				$.each(data.applyCouponExList, function (idx, obj) {
					if (obj.memberKeepingCouponSn > 0) {
						couponStr += AP.common.getTemplate('order.coupon-use-list', {
							coupon: obj
						});
						console.log("받은목록: " + obj.memberKeepingCouponSn);
						couponDcAmtSum += obj.applyDcAmt;
					}
				});

				//화면적용
				$('#coupon_list').html('');
				$('#coupon_list').append(couponStr);
				if (couponDcAmtSum == 0) {
					//0원 노출 안함.
					$('#couponDcAmtSum').html('');
				} else {
					$('#couponDcAmtSum').html('-' + $B.string.numberFormat(couponDcAmtSum) + '원');
				}

				// 쿠폰 취소
				$('[name=removeCoupon]').off('click').on('click', function (e) {
					//console.log(this.dataset.sn);
					var sn = this.dataset.sn;

					//전제목록
					var removeCouponSnArr = [];
					$('[name=removeCoupon]').each(function(i, selected){
						removeCouponSnArr.push(this.dataset.sn);
					});

					//삭제후의 목록
					removeCouponSnArr = removeCouponSnArr.filter(function (item, index) {
						return item != sn
					});

					drawCouponList(removeCouponSnArr, 'remove');
				});
			}

			amtPcurInitAjax(data);

			if ($('[name="depositPrice"]').length > 0 && $('[name="depositPrice"]').val() != ""
				|| $('[name="beauty_point"]').length > 0 && $('[name="beauty_point"]').val() != "") {
				AP.modal.alert('쿠폰 사용으로 포인트 및 예치금 사용이 초기화됩니다. <br/>포인트 및 예치금 사용액을 다시 입력해 주세요.');
				$('[name="depositPrice"]').val('');
				$('[name="beauty_point"]').val('');
			}
		}

	</script>
</dl>

