<html ap:decorate="~{layout/layout-order-only}">

<body>
<!-- #ap_container -->
<div ap:fragment="layout-contents">

	<!-- page contents -->
	<div class="ap_contents ap_cart">

		<form id="order-info" class="validate" method="post" action="/order/reception">
			<!--주문접수 데이터-->
			<input type="hidden" name="memberSn" th:value="${memberSn}"/>
			<input type="hidden" name="cartSn" th:value="${cartEx.cartSn}"/>
			<input type="hidden" name="orderFlag" value="cart"/>
			<input type="hidden" name="onlineProdSnArr"/>													<!--온라인쇼핑 상품-->
			<th:block th:unless="${memberSn > 0}"><input type="hidden" name="NonMember" value="NonMember"/></th:block>
			
			<!--쇼핑 상품-->
			<th:block ap:replace="~{cart/fragment/cart-01-online-product}"/>
			 
			<!-- 인기 상품 -->
			<div class="section pd_md">
			<dl>
				<dt class="h_title d4">스킨베일베이스와 비슷한 인기상품</dt>
				<dd class="product_slide">
					<div class="swipe_wrap">
						<ul class="product_list_new swipe">
							<li>
								<!-- 상품 리스트 -->
								<div class="product_new">
									<a href="javascript:;">
										<!--  상품이미지  -->
										<span class="product_visual_new">
											<span class="out_of_stock"><span class="img_badge">일시품절</span></span>
											<span class="lazy_load_wrap">
												<img src="" data-src="/mo/ko/images/dummy/img_item_01.jpg" alt="" class="lazy_load">
											</span>
										</span>

										<!-- 상품 정보 -->
										<span class="product_info_new">
											<strong class="prd_brand">마몽드</strong>
											<span class="prd_name">세라마이드 크림</span>
											<span class="price_wrap">
												<strong class="discount">30%</strong>
												<strong class="price">30,300<em>원</em></strong>
												<del>29,000원</del>
											</span>

											<!-- 평점 리뷰 -->
											<span class="product_rating">
												<span class="mark_star_sm star0"><span class="sr_only">구매 평점 별 5개 중 개</span></span>
												<span class="prd_review">리뷰 828</span>
											</span>

										</span>
									</a>
								</div>
								<!-- // 상품 리스트 -->
							</li>
						</ul>
					</div>
				</dd>
			</dl>
		</div>
		</form>

		<!--/* 금액 계산 */-->
		<div class="section product_price" id="calculationResult">
		</div>
		<!--/* 주문변경 레이어 */-->
		<div class="order_layer"><!--/* 구매하기 클릭시 open 클래스 */-->
			<!--/* 기본 버튼 */-->
			<div class="default_btns">
				<div class="order_summary" id="calculationResultDetail">
				</div>
				<button type="button" class="btn_lg_neutral" onclick="fnCheckOrder()">주문하기</button>
			</div>
			<!--/* 옵선선택 레이어 */-->
			<div class="option_layer"> <!--/* 옵션 select 선택시 open */-->
				<button type="button" class="option_close"><span class="sr_only">옵션선택 레이어 닫기</span></button>
				<!--/* 옵션선택 select */-->
				<div class="option_select_wrap">
					<div class="ui_select type2" data-not-label-change="true">
						<input type="hidden" name="">
						<button type="button">옵션을 선택해주세요</button>
						<ul class="select_options option_select_list">
							<li class="select_option">
								<code class="label_markup" style="display:none">선택 1</code>
								<a data-value="01">
									<span class="color_chip" style="background-color: #f00;"></span>
									<span class="option_info">
										<span class="option_name">라이트 퍼플 50호 라이트 퍼플 50호 라이트 퍼플 50호</span>
										<span class="price">
											<em class="discount">30%</em>
											<b class="num">37,000</b>원
											<del>42,000원</del>
										</span>
									</span>
								</a>
							</li>
							<li class="select_option">
								<code class="label_markup" style="display:none">선택 1</code>
								<a data-value="02">
									<span class="color_chip"><img alt="" ap:src="@{/images/dummy/img_item_07.jpg}"></span>
									<span class="option_info">
										<span class="option_name">라이트 퍼플 50호</span>
										<span class="price">
											<b class="num">37,000</b>원
										</span>
									</span>
								</a>
							</li>
							<li class="select_option">
									<code class="label_markup" style="display:none">선택 1</code>
									<a data-value="03" class="out_of_stock"> <!--/* 일시품절시.. 선택 가능 */-->
											<span class="color_chip"><img alt="" ap:src="@{/images/dummy/img_color_chip.jpg}"></span>
											<span class="option_info">
													<span class="option_name">라이트 퍼플 50호 라이트 퍼플 50호 라이트 퍼플 50호 라이트 퍼플 50호</span>
													<span class="price">
															<small>일시품절</small>
													</span>
											</span>
									</a>
							</li>
							<li class="select_option">
									<code class="label_markup" style="display:none">선택 1</code>
									<a data-value="04">
											<span class="color_chip" style="background-color: #f00;"></span>
											<span class="option_info">
													<span class="option_name">라이트 퍼플 50호</span>
													<span class="price">
															<em class="discount">30%</em>
															<b class="num">37,000</b>원
															<del>42,000원</del>
													</span>
											</span>
									</a>
							</li>
							<li class="select_option">
									<code class="label_markup" style="display:none">선택 1</code>
									<a data-value="05">
											<span class="color_chip"><img alt="" ap:src="@{/images/dummy/img_item_07.jpg}"></span>
											<span class="option_info">
													<span class="option_name">라이트 퍼플 50호</span>
													<span class="price">
															<b class="num">37,000</b>원
													</span>
											</span>
									</a>
							</li>
							<li class="select_option">
									<code class="label_markup" style="display:none">선택 1</code>
									<a data-value="06" class="out_of_stock"> <!--/* 일시품절시.. 선택 가능 */-->
											<span class="color_chip"><img alt="" ap:src="@{/images/dummy/img_color_chip.jpg}"></span>
											<span class="option_info">
													<span class="option_name">라이트 퍼플 50호 라이트 퍼플 50호 라이트 퍼플 50호 라이트 퍼플 50호</span>
													<span class="price">
															<small>일시품절</small>
													</span>
											</span>
									</a>
							</li>
							<li class="select_option">
									<code class="label_markup" style="display:none">선택 1</code>
									<a data-value="07">
											<span class="color_chip"><img alt="" ap:src="@{/images/dummy/img_item_07.jpg}"></span>
											<span class="option_info">
													<span class="option_name">라이트 퍼플 50호</span>
													<span class="price">
															<b class="num">37,000</b>원
													</span>
											</span>
									</a>
							</li>
							<li class="select_option">
									<code class="label_markup" style="display:none">선택 1</code>
									<a data-value="07">
											<span class="color_chip"><img alt="" ap:src="@{/images/dummy/img_item_07.jpg}"></span>
											<span class="option_info">
													<span class="option_name">라이트 퍼플 50호</span>
													<span class="price">
															<b class="num">37,000</b>원
													</span>
											</span>
									</a>
							</li>
							<li class="select_option">
									<code class="label_markup" style="display:none">선택 1</code>
									<a data-value="07">
											<span class="color_chip"><img alt="" ap:src="@{/images/dummy/img_item_07.jpg}"></span>
											<span class="option_info">
													<span class="option_name">라이트 퍼플 50호</span>
													<span class="price">
															<b class="num">37,000</b>원
													</span>
											</span>
									</a>
							</li>
							<li class="select_option">
									<code class="label_markup" style="display:none">선택 1</code>
									<a data-value="07">
											<span class="color_chip"><img alt="" ap:src="@{/images/dummy/img_item_07.jpg}"></span>
											<span class="option_info">
													<span class="option_name">라이트 퍼플 50호</span>
													<span class="price">
															<b class="num">37,000</b>원
													</span>
											</span>
									</a>
							</li>
							<li class="select_option">
									<code class="label_markup" style="display:none">선택 1</code>
									<a data-value="07">
											<span class="color_chip"><img alt="" ap:src="@{/images/dummy/img_item_07.jpg}"></span>
											<span class="option_info">
													<span class="option_name">라이트 퍼플 51호</span>
													<span class="price">
															<b class="num">37,000</b>원
													</span>
											</span>
									</a>
							</li>
						</ul>
					</div>
				</div>
				<!--/* 선택된 옵션 scroll area */-->
				<div class="selected_option_wrap scrollable_y"> <!--/* option_select_wrap 와 order_bottom 사이즈를 제외한 max-height 필요*/-->
					<div class="selected_option">
						<div class="option_name">라이트 퍼플 40호</div>
						<div class="ui_spinner" data-min="1" data-max="20" data-step="1" data-disabled="false">
							<button class="spinner_decrease" type="button"><i class="ico_oper_p"></i><span class="sr_only">제품 수량 감소</span></button>
							<input class="spinner_input" type="text" title="선택품목갯수" id="" value="1" name="">
							<button class="spinner_increase" type="button"><i class="ico_oper_p plus"></i><span class="sr_only">제품 수량 증가</span></button>
						</div>
						<div class="price"><b>37,000</b>원</div>
						<button class="ui_close" type="button"><span class="sr_only">선택 옵션 삭제</span></button>
					</div>
					<div class="selected_option">
						<div class="option_name">라이트 퍼플 40호 라이트 퍼플 40호 라이트 퍼플 40호 라이트 퍼플 40호</div>
						<div class="ui_spinner" data-min="1" data-max="20" data-step="1" data-disabled="false">
							<button class="spinner_decrease" type="button"><i class="ico_oper_p"></i><span class="sr_only">제품 수량 감소</span></button>
							<input class="spinner_input" type="text" title="선택품목갯수" id="" value="1" name="">
							<button class="spinner_increase" type="button"><i class="ico_oper_p plus"></i><span class="sr_only">제품 수량 증가</span></button>
						</div>
						<div class="price"><b>37,000</b>원</div>
						<button class="ui_close" type="button"><span class="sr_only">선택 옵션 삭제</span></button>
					</div>
					<!--/* 단독으로 쓰이는 경우 옵션 삭제 버튼 없음 */-->
					<div class="selected_option">
						<div class="option_name">라이트 퍼플 40호 라이트 퍼플 40호 라이트 퍼플 40호 라이트 퍼플 40호</div>
						<div class="ui_spinner" data-min="1" data-max="20" data-step="1" data-disabled="false">
							<button class="spinner_decrease" type="button"><i class="ico_oper_p"></i><span class="sr_only">제품 수량 감소</span></button>
							<input class="spinner_input" type="text" title="선택품목갯수" id="" value="1" name="">
							<button class="spinner_increase" type="button"><i class="ico_oper_p plus"></i><span class="sr_only">제품 수량 증가</span></button>
						</div>
						<div class="price"><b>37,000</b>원</div>
					</div>
					<!--/* 일시품절 케이스 */-->
					<div class="selected_option out_of_stock">
						<div class="option_name">라이트 퍼플 40호 라이트 퍼플 40호 라이트 퍼플 40호 라이트 퍼플 40호</div>
						<div class="alarm">
							일시품절 <a href="javascript:;" class="btn_h32_gradient">입고알리미신청</a>
						</div>
						<div class="price"><b>37,000</b>원</div>
						<button class="ui_close" type="button"><span class="sr_only">선택 옵션 삭제</span></button>
					</div>
				</div>
				<div class="order_bottom">
					<!--/* 1 + 1 상품인 경우  */-->
					<p class="text notice">해당상품은 <em>1+1</em> 상품입니다.<br>구매수량을 2개 선택시, 1개 가격으로 혜택이 적용됩니다.</p>
					<!--/* 선택, 금액 */-->
					<div class="total clear">
						<div><span class="num">1</span>개 선택</div>
						<dl>
							<dt>총금액</dt>
							<dd class="price"><em><b class="num">37,000</b>원</em></dd>
						</dl>
					</div>
					<!--/* 버튼 */-->
					<div class="purchase_btns">
						<button type="button" class="btn_lg_neutral">장바구니</button>
						<button type="button" class="btn_lg_neutral" disabled>구매하기</button>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- // page contents -->
</div>
<!-- // #ap_container -->
<!--/* 하단 js등을 실행하는 마지막 영역 */-->
<th:block ap:fragment="layout-endpoint">

	<script ap:src="@{/handlebars-templates/compiled/cart/online/prod.js}"></script>						<!-- 온라인 상품 -->
	<script ap:src="@{/handlebars-templates/compiled/cart/online/membership-point-prod.js}"></script>		<!-- 온라인 뷰티포인트상품 -->
	<script ap:src="@{/handlebars-templates/compiled/cart/online/mn-promo-list.js}"></script>				<!-- 온라인 프로모션 상품목록 -->
	<script ap:src="@{/handlebars-templates/compiled/cart/online/same-time-promo-list.js}"></script>		<!-- 온라인 동시구매 상품목록 -->

	<script ap:src="@{/handlebars-templates/compiled/cart/calculation-result.js}"></script>					<!-- 결제목록 -->
	<script ap:src="@{/handlebars-templates/compiled/cart/calculation-result-detail.js}"></script>			<!-- 결제목록 상세 -->

	<script ap:src="@{/handlebars-templates/compiled/cart/empty-prod.js}"></script>							<!-- 상품목록이 존재하지 않을때 -->

	<script ap:src="@{/handlebars-templates/compiled/cart/layer-option-02.js}"></script>					<!-- 옵션변경 -->
	
	<!-- <script ap:src="@{/handlebars-templates/compiled/my/location-auth.js}"></script> 						위치기반 동의 -->
	<!-- <script ap:src="@{/handlebars-templates/compiled/products/none-member-order-info-modal.js}"></script>	비회원 동의 -->

	<script th:inline="javascript">
	$( document ).ready(function() {
		$( '.ui_spinner' ).spinner();

		/* 주문서 진입 실패시 에러처리 */
		var ordErr = /*[[${ordErr}]]*/ null;
		if(ordErr != null){
			var result = ordErr.result,
				errorCode = ordErr.errorCode,
				errorMessage = ordErr.errorMessage,
				errorAdditional = ordErr.errorAdditional;
			if (!result) {
				AP.modal.alert(errorMessage + '(' + errorCode + ')<br/>' + errorAdditional.detail);
			}
		}
	});

	var pageLimit = 5;
	var currentKeyword;
	var currentOffset = 0;

	/* 회원일련 번호*/
	var memberSn = /*[[${memberSn}]]*/;

	/* 카트 정보 */
	var cartEx = /*[[${cartEx}]]*/;

	/* 뷰티포인트 정보 */
	var bpMembershipEx = /*[[${bpCartMemberMembershipEx}]]*/;

	/* 선택매장 정보 */
	var storeSelect = /*[[${storeSelect}]]*/;

	/* 단골매장매장 정보 */
	var storeRegularList = /*[[${storeRegularList}]]*/;

	/* 지역시군구 정보 */
	var addressDivInfoList = /*[[${addressDivInfoList}]]*/;

	/* 장바구니 번호 */
	var cartSn = cartEx.cartSn;

	/* 빈 장바구니에서 보여줄 브랜드 정보*/
	var emptyCartViewBrand = /*[[${emptyCartViewBrand}]]*/
	var xhr;

	/* 온라인 체크시 */
	$('#allPrdCheck').on('click', function(e) {
		if($(this).is(":checked")){
			$('[name="chkBox"]').prop('checked', true);
		} else {
			$('[name="chkBox"]').prop('checked', false);
		}
		calculateSelectCartProds();
	});

	/* 온라인 상품 */
	setOnlineProd();
	
	/* 상품가격 정보 */
	setCalculationResult();

	/* 상품목록 카운트 */
	setProdCnt();

	/* 온라인상품 */
	function setOnlineProd() {
		$( '.ui_spinner' ).spinner();
		$('#allOnlineProd .ui_accordion dl dd').empty();
		if (cartEx.cartDeliveryOnlineProdExList.length > 0) {
			var onlineHtml = AP.common.getTemplate('cart.online.prod', {
				cartEx : cartEx
			});
			$('#onlinePrdCnt').html(cartEx.cartDeliveryOnlineProdExList.length);
			$('#allOnlineProd .ui_accordion dl dd').append(onlineHtml);		
		}
		if (cartEx.cartDeliveryOnlineProdExList.length == 0
			&& cartEx.cartDeliveryMNPromoExList.length == 0
			&& cartEx.cartDeliverySameTimePurPromoExList.length == 0
			&& cartEx.cartDeliveryMembershipPointExchOnlineProdExList.length == 0) {
			var onlineHtml = AP.common.getTemplate('cart.empty-prod', {
				url : emptyCartViewBrand.menuTitleImgUrl
			});
			$('#allOnlineProd').empty();
			$('#allOnlineProd').append(onlineHtml);
			console.log(emptyCartViewBrand);
		}
		$('[name=chkBox]').on('click', function(e) {
			if($(this).is(":checked")){
				if(fncheckExchPoint($(this)) == false){
					return;
				}
			}
			$('[name="allPrdCheck"]').prop('checked', $( '[name=chkBox]' ).length == $( '[name=chkBox]:checked' ).length);
			calculateSelectCartProds();
		});
	}

	/* 최종결제 금액 계산 */
	function setCalculationResult() {
		$('#calculationResult').empty();
		$('#calculationResultDetail').empty();
		var calculationHtml = AP.common.getTemplate('cart.calculation-result', {
			cartEx : cartEx
		});
		$('#calculationResult').append(calculationHtml);
		var calculationDetailHtml = AP.common.getTemplate('cart.calculation-result-detail', {
			cartEx : cartEx
		});
		$('#calculationResultDetail').append(calculationDetailHtml);
	}

	function setProdCnt() {
		/* 온라인상품 수량 */
		var onlineCnt			= $("input[name=onlinePrdSn]").length;							// 온라인상품 수량
		var onlineMembershipCnt = $("input[name=onlineMembershipPrdSn]").length;		// 온라인맴버쉽포인트상품 수량
		var onlineTotalCnt		= onlineCnt + onlineMembershipCnt;  		// 온라인 총 수량
		var onlineChkCnt		=  $( "input[name=chkBox]:checked" ).length;					// 상품 체크수량

		/* 온라인 쇼핑 상품 갯수 */
		$("#onlinePrdCnt").html(onlineTotalCnt);

		/* 온라인 총 수량 */
		$("#calOnlinePrdCnt").html(onlineTotalCnt);
		
		/* 맴버쉽포인트 총 수량 */
		$("#calMemberPrdCnt").html(onlineMembershipCnt);

		/* 총주문 갯수 */
		$("span[name=totalPrdCnt]").html(onlineCnt);
		console.log(onlineCnt)
	}


	/* 상품상세 이동 */
	function fnProdDetail(onlineProdSn) {
		location.href = '/product/detail?onlineProdSn=' + onlineProdSn;
	}

	/* 주문결제하기 */
	function fnCheckOrder() {

		var chkCnt 			= $("[name=chkBox]:checked").length;			// 온라인상품 선택갯수

		// 온라인 상품이 체크되지 않았을때
		if (chkCnt == 0) {
			AP.modal.alert("선택된 상품이 없습니다.");
			return false;
		}

		if(chkCnt > 0){
			fnOrderProdReception(chkCnt, 0);
		}
		
		return true;
	}

	/* 주문결제하기(온라인상품 and 테이크아웃상품) */
	function fnOrderReception(chkCnt) {
		var prdCdArr = [];
		var prdInfoVal ;

		if(chkCnt > 0){
			$("input[name=chkBox]:checked").each(function() {
				var rowCartProdSn = $(this).val();
				$('.cart_item_info').find("[name='prdInfo_" + rowCartProdSn + "']").each(function(){
					var rowSaleDisplayStatus = $('.cart_item_info').find("[name='saleDisplayStatus_" + rowCartProdSn + "']").val();
					if(rowSaleDisplayStatus == 'OnSale'){
						prdInfoVal = $(this).val();
						prdCdArr.push(prdInfoVal);
						$("[name='onlineProdSnArr']").val(prdCdArr);
					}
				});
			});
			var $form = $('form.validate');
			$form.submit();
		}
	}

	/* 주문결제하기(온라인상품 or 테이크아웃상품) */
	function fnOrderProdReception(chkCnt) {
		var prdCdArr = [];
		var prdInfoVal;

		if(chkCnt > 0){
			$("input[name=chkBox]:checked").each(function() {
				var rowCartProdSn = $(this).val();
				$('.cart_item_info').find("[name='prdInfo_" + rowCartProdSn + "']").each(function(){
					var rowSaleDisplayStatus = $('.cart_item_info').find("[name='saleDisplayStatus_" + rowCartProdSn + "']").val();
					if(rowSaleDisplayStatus == 'OnSale'){
						prdInfoVal = $(this).val();
						prdCdArr.push(prdInfoVal);
						$("[name='onlineProdSnArr']").val(prdCdArr);
					}
				});
			});
			var $form = $('form.validate');
			$form.submit();
		}
	}

	/* 옵션변경 Layer */
	function fnUnitVariationProds(cartSn, cartProdSn, prodSn, cartProdQty, storePickupYn) {
		AP.api.getLayerPage({}, {
			cartProdSn: cartProdSn,
			prodSn: prodSn
		}).done(function (data) {
			if (data.result == "success") {
				var modal = AP.modal.open({
					templateKey: 'cart.layer-option-02',
					templateModel: { list : data.param, prodSn : prodSn }
				});
				// design select 적용
				$( '.ui_select' ).designSelectBox();

				// selectBox 적용 === PC버전 동일하게 설정?
				//modal.getElement().find( 'select' ).selectBox();

				var $modalEl = modal.getElement();
				$modalEl.find(".btn_md_neutral").click(function() {
					var prodSnVal = $('[name=prodSn]').val();
					if(prodSnVal == ''){
						AP.modal.alert("변경하실 옵션을 선택하세요.");
					}else{
						if (xhr != null){
							xhr.abort();
						}

						var indexed_array = {};
						indexed_array['cartSn'] = cartSn;
						indexed_array['cartProdSn'] = cartProdSn;
						indexed_array['prodSn'] = prodSnVal;
						indexed_array['cartProdQty'] = cartProdQty;
						indexed_array['storePickupYn'] = storePickupYn;
						indexed_array['modifyType'] = "O";

						xhr = $.ajax({
							type: "PUT",
							url: "/cart/modifyCartProd",
							data: indexed_array,
							error : function(xhr, textStatus, errorThrown) {},
							success: function(data){
								if (data.data) {
									cartEx = data.data;
									setOnlineProd();
									setCalculationResult();
									setProdCnt();
									modal.close();
								}
							}
						});
					}
				});
				$modalEl.find(".btn_md_secondary").click(function() {
					modal.close();
				});
			}
		}).fail(function (e) {
			AP.modal.alert("[ajax.fail]실패");
			modal.close();
		}).always(function () {
		});
	}

	/* 선택삭제 */
	function selectRemoveCartProd() {

		var chkCnt 			= $("[name=chkBox]:checked").length;			// 온라인상품 선택갯수
		
		if (chkCnt == 0) {
			AP.modal.alert("선택된 상품이 없습니다.");
			return false;
		}
		AP.modal.confirm( '선택한 상품을 장바구니에서 삭제하시겠습니까? ' ).addListener( 'modal-close', function (e) {
			//console.log( e.closeType ); //close, confirm, cancel
			if(e.closeType == 'confirm'){
				var prdCdArr = [];
				var prdInfoVal;

				if(chkCnt > 0 ){
					$("input[name=chkBox]:checked").each(function() {
						var rowChkVal = $(this).val();
						$('.cart_item_info').find("[name='prdInfo_" + rowChkVal + "']").each(function(){
							prdInfoVal = $(this).val();
							prdCdArr.push(prdInfoVal);
						});
					});
				}
				jQuery.ajaxSettings.traditional = true;
				AP.api.removeSelectCartProd({}, {
					cartSn : cartSn,
					prdCdArr: prdCdArr,
				}).done(function (data) {
					if (data.data) {
						AP.modal.alert("해당상품이 삭제되었습니다.").addListener( 'modal-close', function (e) {
							cartEx = data.data;
							setOnlineProd();
							setCalculationResult();
							setProdCnt();
						});
					}
				}).fail(function (e) {
					AP.modal.alert("fail");
				}).always(function () {

				});
			}
		});
	}

	/* 선택상품재계산 */
	function calculateSelectCartProds() {

		var prdCdArr = [];
		var prdInfoVal;

		var chkCnt = $("[name=chkBox]:checked").length;					// 온라인상품 선택갯수

		if(chkCnt > 0 ){
			$("input[name=chkBox]:checked").each(function() {
				var rowChkVal = $(this).val();			
				$('.selected_option[data-value="' + rowChkVal + '"]').each(function(){
					$(this).find("[name='prdInfo']").each(function(){
						prdInfoVal = $(this).val();
						prdCdArr.push(prdInfoVal);
					});
				})
			});
		}
		
		jQuery.ajaxSettings.traditional = true;
		AP.api.getCartBySelectCartProds({}, {
			cartSn : cartSn,
			prdCdArr: prdCdArr,
		}).done(function (data) {
			if (data.data) {
				cartEx = data.data;
				setOnlineProd();
				setCalculationResult();
				setProdCnt();
			}
		}).fail(function (e) {
			AP.modal.alert("fail");
		}).always(function () {
		});
	}

	/* 맴버쉽,활동 포인트 체크 */
	function fncheckExchPoint(obj) {
		
		if(memberSn > 0){
			var membershipPoints = 0;
			var membershipSum = 0;

			$('[name=chkBox]:checked').each(function () {
				if ($(this).attr('pointExch') != undefined && $(this).attr('pointExch') == "membership") {
					membershipSum += Number($(this).attr('point'));
				}
			});

			if(bpMembershipEx != null){
				membershipPoints = bpMembershipEx.membershipPoints;
			}else{
				membershipPoints = 0;
			}

			if (membershipSum > membershipPoints) {
				AP.modal.alert('보유 뷰티포인트가 부족합니다. 상품을 다시 선택해주세요.');
				$(obj).attr('checked', false);
				return false;
			}else{
				$(obj).attr('checked', true);
			}
			return true;
		}
	}

	/* 단일삭제(동시구매상품) */
	function sameTimeRemoveCartProd(cartSn, promoIndex, method) {
		AP.modal.confirm( '선택한 상품을 장바구니에서 삭제하시겠습니까? ' ).addListener( 'modal-close', function (e) {
			if(e.closeType == 'confirm'){
				var prdCdArr = [];
				var rowCartProdSn ;

				if(method == 'online') {
					$('.cart_item_info').find("[name='prdInfo_" + promoIndex + "']").each(function () {
						rowCartProdSn = $(this).val();
						prdCdArr.push(rowCartProdSn);
					})
				}
				jQuery.ajaxSettings.traditional = true;
				AP.api.removeSelectCartProd({}, {
					cartSn : cartSn,
					prdCdArr: prdCdArr,
				}).done(function (data) {
					if (data.data) {
						AP.modal.alert("해당상품이 삭제되었습니다.").addListener( 'modal-close', function (e) {
							cartEx = data.data;
							setOnlineProd();
							setCalculationResult();
							setProdCnt();
						});
					}
				}).fail(function (e) {
					AP.modal.alert("fail");
				}).always(function () {
					// 성공, 실패
				});
			}
		});
	}

	/* 단일삭제(단위상품기준) */
	function removeCartProd(cartSn, cartProdSn) {
		AP.modal.confirm( '선택한 상품을 장바구니에서 삭제하시겠습니까? ' ).addListener( 'modal-close', function (e) {
			//console.log( e.closeType ); //close, confirm, cancel
			if(e.closeType == 'confirm'){
				jQuery.ajaxSettings.traditional = true;
				AP.api.removeCartProd({}, {
					cartSn: cartSn,
					cartProdSn : cartProdSn
				}).done(function (data) {
					if (data.data) {
						AP.modal.alert("해당상품이 삭제되었습니다.").addListener( 'modal-close', function (e) {
							cartEx = data.data;
							setOnlineProd();
							setCalculationResult();
							setProdCnt();
						});
					}
				}).fail(function (e) {
					AP.modal.alert("fail");
				}).always(function () {
					// 성공, 실패
				});
			}
		});
	}

	/* 단일삭제(온라인상품기준) */
	function removeCartOnlineProd(cartSn, onlineProdSn, method) {
		AP.modal.confirm( '선택한 상품을 장바구니에서 삭제하시겠습니까? ' ).addListener( 'modal-close', function (e) {
			if(e.closeType == 'confirm'){
				var prdCdArr = [];
				var prdInfoVal;

				if(method == 'online') {
					$('.cart_item_info').find("[name='prdInfo_" + onlineProdSn + "']").each(function(){
						prdInfoVal = $(this).val();
						prdCdArr.push(prdInfoVal);
					})
				}
				
				jQuery.ajaxSettings.traditional = true;
				AP.api.removeSelectCartProd({}, {
					cartSn : cartSn,
					prdCdArr: prdCdArr,
				}).done(function (data) {
					if (data.data) {
						AP.modal.alert("해당상품이 삭제되었습니다.").addListener( 'modal-close', function (e) {
							cartEx = data.data;
							setOnlineProd();
							setCalculationResult();
							setProdCnt();
						});
					}
				}).fail(function (e) {
					AP.modal.alert("fail");
				}).always(function () {

				});
			}
		});
	}

	/* 주문수량 수정 */
	function prodQtyOperate(num, cartSn, cartProdSn, prodSn,
							integrationMembershipExchYn, activityPointExchYn, storePickupYn, storeSn, operate) {

		var ordQty = parseInt($(num).closest("div").find("input[name=cartProdQty]").val());
		if(operate == '+'){
			ordQty++;
		}
		else if(operate == '-'){
			ordQty--;
		}
		if (xhr != null){
			xhr.abort();
		}

		var indexed_array = {};
		indexed_array['cartSn'] = cartSn;
		indexed_array['cartProdSn'] = cartProdSn;
		indexed_array['prodSn'] = prodSn;
		indexed_array['cartProdQty'] = ordQty;
		indexed_array['storePickupYn'] = storePickupYn;
		indexed_array['storeSn'] = storeSn;
		indexed_array['integrationMembershipExchYn'] = integrationMembershipExchYn;
		indexed_array['activityPointExchYn'] = activityPointExchYn;
		indexed_array['modifyType'] = "Q";

		var cartBulkIncludedProdSn	= $('.cart_item_scroll').find("[name='bulkPrdInfo_" + cartProdSn + "']").attr('cartBulkIncludedProdSn');
		var bulkDcIncludedProdGrpSn	= $('.cart_item_scroll').find("[name='bulkPrdInfo_" + cartProdSn + "']").attr('bulkDcIncludedProdGrpSn');
		var includedProdSn			= $('.cart_item_scroll').find("[name='bulkPrdInfo_" + cartProdSn + "']").attr('includedProdSn');
		var includedProdQty			= $('.cart_item_scroll').find("[name='bulkPrdInfo_" + cartProdSn + "']").attr('includedProdQty');

		if(cartBulkIncludedProdSn != undefined
			&& bulkDcIncludedProdGrpSn != undefined
			&& includedProdSn != undefined
			&& includedProdQty != undefined){
			indexed_array['cartBulkIncludedProdSn'] = cartBulkIncludedProdSn;
			indexed_array['bulkDcIncludedProdGrpSn'] = bulkDcIncludedProdGrpSn;
			indexed_array['includedProdSn'] = includedProdSn;
			indexed_array['includedProdQty'] = includedProdQty;
		}

		xhr = $.ajax({
			type: "PUT",
			url: "/cart/modifyCartProd",
			data: indexed_array,
			error : function(xhr, textStatus, errorThrown) {},
			success: function(data){
				if (data.data) {
					cartEx = data.data;
					setOnlineProd();
					setCalculationResult();
					setProdCnt();
				}
			}
		});
	}
	</script>
</th:block>
</body>
</html>